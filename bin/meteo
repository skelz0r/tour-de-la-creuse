#!/bin/bash

JOURS="${1:-7}"
LIEU="${2:-Bordeaux}"

if [ "$JOURS" -lt 1 ] || [ "$JOURS" -gt 14 ]; then
  echo "Nombre de jours doit Ãªtre entre 1 et 14"
  exit 1
fi

get_coords() {
  curl -s "https://geocoding-api.open-meteo.com/v1/search?name=$1&count=1&language=fr" | jq -r '.results[0] | "\(.latitude) \(.longitude) \(.name)"'
}

read -r LAT LON NOM <<< "$(get_coords "$LIEU")"

if [ -z "$LAT" ] || [ "$LAT" = "null" ]; then
  echo "Lieu non trouvÃ©: $LIEU"
  exit 1
fi

METEO=$(curl -s "https://api.open-meteo.com/v1/forecast?latitude=$LAT&longitude=$LON&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,weather_code&daily=sunrise,sunset&timezone=auto&forecast_days=$JOURS")

echo "MÃ©tÃ©o $JOURS jour(s) - $NOM"
echo "===================================="
echo ""

DOW=$(date +%u)

echo "$METEO" | jq -r --argjson jours "$JOURS" --argjson dow "$DOW" '
  ["lun", "mar", "mer", "jeu", "ven", "sam", "dim"] as $jours_fr |
  .hourly as $h |
  .daily as $d |
  ($h.time | length) as $len |
  [range(0; $len)] |
  group_by(. / 24 | floor) |
  .[:$jours] |
  .[] |
  .[0] as $first |
  ($h.time[$first] | split("T")[0]) as $date |
  (($first / 24) | floor) as $day_idx |
  $jours_fr[(($dow - 1 + $day_idx) % 7)] as $jour |
  $d.sunrise[$day_idx] as $sunrise |
  $d.sunset[$day_idx] as $sunset |
  "\nðŸ“… \($jour). \($date) (lever: \($sunrise | split("T")[1]) / coucher: \($sunset | split("T")[1]))",
  "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",
  "Heure  Temp   Pluie%  PrÃ©c.   Vent    Conditions",
  "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",
  ([.[] | select(. % 24 >= 7 and . % 24 <= 20)] | .[] |
    $h.time[.] as $time |
    ($time | split("T")[1] | split(":")[0]) as $hour |
    $h.temperature_2m[.] as $temp |
    $h.precipitation_probability[.] as $prob |
    $h.precipitation[.] as $prec |
    $h.wind_speed_10m[.] as $wind |
    $h.weather_code[.] as $code |
    (if $code == 0 then "â˜€ï¸ DÃ©gagÃ©"
     elif $code <= 3 then "â›… Nuageux"
     elif $code <= 48 then "ðŸŒ«ï¸ Brouillard"
     elif $code <= 55 then "ðŸŒ§ï¸ Bruine"
     elif $code <= 67 then "ðŸŒ§ï¸ Pluie"
     elif $code <= 77 then "â„ï¸ Neige"
     elif $code <= 82 then "ðŸŒ¦ï¸ Averses"
     elif $code <= 86 then "ðŸŒ¨ï¸ Neige"
     else "â›ˆï¸ Orage" end) as $cond |
    (if $prob >= 50 or $prec > 0.5 then "âŒ" elif $prob >= 30 then "ðŸ¤·" else "âœ…" end) as $velo |
    "\($hour)h    \($temp | tostring | .[:4] | if length < 4 then . + " " else . end)Â°  \($prob | tostring | if length < 2 then " " + . else . end)%     \($prec | tostring | .[:3])mm   \($wind | tostring | .[:2])km/h  \($cond) \($velo)"
  )
'
